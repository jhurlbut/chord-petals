(()=>{function f({uint8View:o,dataView:t,bufferStart:e,bufferSize:s,head:S,tail:l,messageMagic:i,paddingMagic:x,headerSize:I,maxMessages:R=1/0,onMessage:T,onCorruption:n}){let E=l,B=0,p=H=>{let a=H;if(a+4<=s)return t.getUint32(e+a,!0);let D=0;for(let A=0;A<4;A++)D|=o[e+(a+A)%s]<<A*8;return D};for(;E!==S&&B<R;){let H=s-E,a;if(H>=4?a=t.getUint32(e+E,!0):a=p(E),a===x){E=0;continue}if(a!==i){n&&n(E),E=(E+1)%s;continue}let D=p((E+4)%s),A=p((E+8)%s),d=p((E+12)%s);if(D<I||D>s){n&&n(E),E=(E+1)%s;continue}let m=D-I,M=e+(E+I)%s;T(M,m,A,d),E=(E+D)%s,B++}return{newTail:E,messagesRead:B}}function O(o,t){let e=o+t;return{DEBUG_HEAD:(e+16)/4,DEBUG_TAIL:(e+20)/4}}var C="sab",U=null,L=null,r=null,G=null,g=null,_=null,c={},N=null,u=!1,P=new TextDecoder("utf-8"),b=(...o)=>{},w=(o,t,e)=>{U=o,L=t,_=e,r=new Int32Array(U),G=new DataView(U),g=new Uint8Array(U),c=O(L,_.CONTROL_START);let s=L+_.METRICS_START;N=new Uint32Array(U,s,_.METRICS_SIZE/4)},W=()=>{let o=Atomics.load(r,c.DEBUG_HEAD),t=Atomics.load(r,c.DEBUG_TAIL);if(o===t)return null;let e=[],{newTail:s,messagesRead:S}=f({uint8View:g,dataView:G,bufferStart:L+_.DEBUG_BUFFER_START,bufferSize:_.DEBUG_BUFFER_SIZE,head:o,tail:t,messageMagic:_.MESSAGE_MAGIC,paddingMagic:_.PADDING_MAGIC,headerSize:_.MESSAGE_HEADER_SIZE,maxMessages:1e3,onMessage:(l,i,x,I)=>{let R=new Uint8Array(i);for(let n=0;n<i;n++)R[n]=g[l+n];let T=P.decode(R);T.endsWith(`
`)&&(T=T.slice(0,-1)),e.push({text:T,timestamp:performance.now(),sequence:x}),N&&(Atomics.add(N,30,1),Atomics.add(N,31,i))},onCorruption:l=>{console.error("[DebugWorker] Corrupted message at position",l)}});return S>0&&Atomics.store(r,c.DEBUG_TAIL,s),e.length>0?e:null},k=()=>{for(;u;)try{let o=Atomics.load(r,c.DEBUG_HEAD),t=Atomics.load(r,c.DEBUG_TAIL);o===t&&Atomics.wait(r,c.DEBUG_HEAD,o);let e=W();e&&e.length>0&&self.postMessage({type:"debug",messages:e})}catch(o){console.error("[DebugWorker] Error in wait loop:",o),self.postMessage({type:"error",error:o.message}),Atomics.wait(r,0,r[0],10)}},Q=()=>{if(!U){console.error("[DebugWorker] Cannot start - not initialized");return}u||(u=!0,k())},K=()=>{u=!1},h=()=>{U&&(Atomics.store(r,c.DEBUG_HEAD,0),Atomics.store(r,c.DEBUG_TAIL,0))},V=o=>{let t=[];for(let e of o)try{let s=new Uint8Array(e.bytes),S=P.decode(s);S.endsWith(`
`)&&(S=S.slice(0,-1)),t.push({text:S,timestamp:performance.now(),sequence:e.sequence})}catch(s){console.error("[DebugWorker] Failed to decode message:",s)}t.length>0&&self.postMessage({type:"debug",messages:t})};self.addEventListener("message",o=>{let{data:t}=o;try{switch(t.type){case"init":C=t.mode||"sab",C==="sab"&&w(t.sharedBuffer,t.ringBufferBase,t.bufferConstants),self.postMessage({type:"initialized"});break;case"start":C==="sab"&&Q();break;case"stop":K();break;case"clear":C==="sab"&&h();break;case"debugRaw":t.messages&&V(t.messages);break;default:}}catch(e){console.error("[DebugWorker] Error:",e),self.postMessage({type:"error",error:e.message})}});b("[DebugWorker] Script loaded");})();
