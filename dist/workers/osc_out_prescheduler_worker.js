(()=>{function j(e,t,r){return(r-1-e+t)%r}function ee({uint8View:e,dataView:t,bufferStart:r,bufferSize:s,head:n,payload:c,sequence:i,messageMagic:_,headerSize:T,sourceId:a=0,headerScratch:b=null,headerScratchView:m=null}){let O=c.length,g=T+O+3&-4,U=s-n;if(g>U){let u=b||new Uint8Array(T),d=m||new DataView(u.buffer);d.setUint32(0,_,!0),d.setUint32(4,g,!0),d.setUint32(8,i,!0),d.setUint32(12,a,!0);let w=r+n,k=r;if(U>=T){e.set(u,w);let C=U-T;C>0&&e.set(c.subarray(0,C),w+T),e.set(c.subarray(C),k)}else{e.set(u.subarray(0,U),w),e.set(u.subarray(U),k);let C=T-U;e.set(c,k+C)}}else{let u=r+n;t.setUint32(u,_,!0),t.setUint32(u+4,g,!0),t.setUint32(u+8,i,!0),t.setUint32(u+12,a,!0),e.set(c,u+T)}return(n+g)%s}function ge(e,t,r=0,s=!1){for(let n=0;n<=r;n++)if(Atomics.compareExchange(e,t,0,1)===0)return!0;if(s){for(let c=0;c<100;c++)if(Atomics.wait(e,t,1,100),Atomics.compareExchange(e,t,0,1)===0)return!0;return console.error("[RingBuffer] Lock acquisition timeout after 10s - possible deadlock"),!1}return!1}function de(e,t){Atomics.store(e,t,0),Atomics.notify(e,t,1)}function te({atomicView:e,dataView:t,uint8View:r,bufferConstants:s,ringBufferBase:n,controlIndices:c,oscMessage:i,sourceId:_=0,maxSpins:T=0,useWait:a=!1}){let b=i.length,m=s.MESSAGE_HEADER_SIZE+b;if(m>s.IN_BUFFER_SIZE-s.MESSAGE_HEADER_SIZE||!ge(e,c.IN_WRITE_LOCK,T,a))return!1;try{let O=Atomics.load(e,c.IN_HEAD),J=Atomics.load(e,c.IN_TAIL),g=m+3&-4;if(j(O,J,s.IN_BUFFER_SIZE)<g)return!1;let u=Atomics.add(e,c.IN_SEQUENCE,1),d=ee({uint8View:r,dataView:t,bufferStart:n+s.IN_BUFFER_START,bufferSize:s.IN_BUFFER_SIZE,head:O,payload:i,sequence:u,messageMagic:s.MESSAGE_MAGIC,headerSize:s.MESSAGE_HEADER_SIZE,sourceId:_});return Atomics.load(e,c.IN_HEAD),Atomics.store(e,c.IN_HEAD,d),Atomics.notify(e,c.IN_HEAD,1),!0}finally{de(e,c.IN_WRITE_LOCK)}}function se(e,t){let r=e+t;return{IN_HEAD:(r+0)/4,IN_TAIL:(r+4)/4,IN_SEQUENCE:(r+24)/4,IN_WRITE_LOCK:(r+40)/4,IN_LOG_TAIL:(r+44)/4}}var p="sab",K=null,W=1024,Me=65536,ce=3600,Se=4294967295,D=null,x=null,f=null,L=null,ue=null,fe=null,B={},E=null,y=null,Ee=null,Z=150,I=(e,t)=>{E&&(p==="sab"?Atomics.store(E,e,t):E[e]=t)},Te=e=>E?p==="sab"?Atomics.load(E,e):E[e]:0,R=(e,t)=>{E&&(p==="sab"?Atomics.add(E,e,t):E[e]+=t)},F=(e,t)=>{E&&(p==="sab"?Atomics.store(E,e,t):E[e]=t)},le=e=>E?p==="sab"?Atomics.load(E,e):E[e]:0,me=()=>{if(p!=="postMessage"||Ee!==null)return;let e=()=>{y&&E&&self.postMessage({type:"preschedulerMetrics",metrics:new Uint32Array(y.slice(0))}),Ee=setTimeout(e,Z)};e(),S("[PreScheduler] Started metrics sending (every "+Z+"ms)")};var o=[],A=null,H=1/0,Oe=0,ie=!1,l=[],Y=!1,P=65536,He=2208988800,$=.5,S=(...e)=>{},V=()=>(performance.timeOrigin+performance.now())/1e3+He,xe=e=>{if(e.length>=16&&e[0]===35){let t=new DataView(e.buffer,e.byteOffset),r=t.getUint32(8,!1),s=t.getUint32(12,!1);return r+s/4294967296}return null},Be=()=>{if(!D||!f){console.error("[PreScheduler] Cannot init - missing buffer or constants");return}L=new Int32Array(D),ue=new DataView(D),fe=new Uint8Array(D),B=se(x,f.CONTROL_START);let e=x+f.METRICS_START;E=new Uint32Array(D,e,f.METRICS_SIZE/4),S("[PreScheduler] SharedArrayBuffer initialized with direct ring buffer writing and metrics")},G=()=>{if(!E)return;I(9,o.length);let e=o.length,t=Te(10);e>t&&I(10,e)},h=(e,t,r=0,s=!1)=>{if(p==="postMessage")return K?(K.postMessage({type:"osc",oscData:e,sourceId:r}),R(12,1),!0):(console.error("[PreScheduler] No worklet port available"),!1);if(!D||!L)return console.error("[PreScheduler] Not initialized for ring buffer writing"),!1;let n=e.length,c=f.MESSAGE_HEADER_SIZE+n;return c>f.IN_BUFFER_SIZE-f.MESSAGE_HEADER_SIZE?(console.error("[PreScheduler] Message too large:",c),!1):te({atomicView:L,dataView:ue,uint8View:fe,bufferConstants:f,ringBufferBase:x,controlIndices:B,oscMessage:e,sourceId:r,maxSpins:10,useWait:s})?(R(12,1),!0):!1},N=(e,t,r=0)=>{let s=o.length+l.length;if(s>=P){console.error("[PreScheduler] Backpressure: dropping retry ("+s+" pending)"),R(17,1);return}l.push({oscData:e,context:t||"unknown",queuedAt:performance.now(),sourceId:r}),I(18,l.length);let n=Te(19);l.length>n&&I(19,l.length),S("[PreScheduler] Queued message for retry:",t,"queue size:",l.length),pe()},pe=()=>{if(Y||l.length===0||p!=="sab")return;Y=!0;let e=Atomics.load(L,B.IN_TAIL),t=Atomics.waitAsync(L,B.IN_TAIL,e),r=()=>{Y=!1,ye(),l.length>0&&pe()};t.async?t.value.then(r):queueMicrotask(r)},ye=()=>{if(l.length===0)return;let e=0;for(;e<l.length;){let t=l[e];if(h(t.oscData,!0,t.sourceId,!0))l.splice(e,1),R(16,1),I(18,l.length);else break}},ae=(e,t,r,s=0)=>{let n=o.length+l.length;if(n>=P){let a=`Prescheduler queue full (${n} >= ${P} max)`;return console.error("[PreScheduler]",a),self.postMessage({type:"error",error:a,code:"PRESCHEDULER_QUEUE_FULL"}),!1}let c=xe(e);if(c===null)return S("[PreScheduler] Non-bundle message, dispatching immediately"),h(e,!1,s,!0)||N(e,"immediate message",s),!0;let i=V(),_=c-i;if(e.length>W){let a=`Bundle too large for scheduler (${e.length} > ${W} bytes)`;return console.error("[PreScheduler]",a),self.postMessage({type:"error",error:a,code:"BUNDLE_TOO_LARGE"}),!1}if(_>ce){let a=`Bundle scheduled too far in future (${_.toFixed(0)}s > ${ce}s max)`;return console.error("[PreScheduler]",a),self.postMessage({type:"error",error:a,code:"BUNDLE_TOO_FAR_FUTURE"}),!1}let T={ntpTime:c,seq:Oe++,sessionId:t||0,runTag:r||"",oscData:e,sourceId:s};return Fe(T),R(11,1),G(),S("[PreScheduler] Scheduled bundle:","NTP="+c.toFixed(3),"current="+i.toFixed(3),"wait="+(_*1e3).toFixed(1)+"ms","pending="+o.length),M(),!0},Fe=e=>{o.push(e),be(o.length-1)},Re=()=>o.length>0?o[0]:null,Ge=()=>{if(o.length===0)return null;let e=o[0],t=o.pop();return o.length>0&&(o[0]=t,Ae(0)),e},be=e=>{for(;e>0;){let t=Math.floor((e-1)/2);if(q(o[e],o[t])>=0)break;Ue(e,t),e=t}},Ae=e=>{let t=o.length;for(;;){let r=2*e+1,s=2*e+2,n=e;if(r<t&&q(o[r],o[n])<0&&(n=r),s<t&&q(o[s],o[n])<0&&(n=s),n===e)break;Ue(e,n),e=n}},q=(e,t)=>e.ntpTime===t.ntpTime?e.seq-t.seq:e.ntpTime-t.ntpTime,Ue=(e,t)=>{let r=o[e];o[e]=o[t],o[t]=r},M=()=>{if(o.length===0){A!==null&&(clearTimeout(A),A=null,H=1/0);return}let e=Re().ntpTime-$,t=V();if(e<H){A!==null&&clearTimeout(A);let r=Math.max(0,(e-t)*1e3);H=e,A=setTimeout(ke,r)}},we=()=>{A===null&&(S("[PreScheduler] Starting demand-driven dispatching"),M())};var ke=()=>{ie=!0;let e=V(),t=e+$,r=0;for(;o.length>0;){let s=Re();if(s.ntpTime<=t){Ge(),G();let n=s.ntpTime-e;if(R(21,1),n<0){let i=Math.round(-n*1e3);R(15,1);let _=le(23);i>_&&F(23,i)}else{let i=Math.round(n*1e3),_=le(14);(_===Se||i<_)&&F(14,i)}S("[PreScheduler] Dispatching bundle:","NTP="+s.ntpTime.toFixed(3),"current="+e.toFixed(3),"early="+(n*1e3).toFixed(1)+"ms","remaining="+o.length),h(s.oscData,!1,s.sourceId,!0)||N(s.oscData,"scheduled bundle NTP="+s.ntpTime.toFixed(3),s.sourceId),r++}else break}(r>0||o.length>0||l.length>0)&&S("[PreScheduler] Dispatch cycle complete:","dispatched="+r,"pending="+o.length,"retrying="+l.length),ie=!1,A=null,H=1/0,M()},z=e=>{if(o.length===0)return;let t=o.length,r=[];for(let n=0;n<o.length;n++){let c=o[n];e(c)||r.push(c)}let s=t-r.length;s>0&&(o=r,Ye(),R(13,s),G(),S("[PreScheduler] Cancelled "+s+" events, "+o.length+" remaining"),M())},Ye=()=>{for(let e=Math.floor(o.length/2)-1;e>=0;e--)Ae(e)},Qe=(e,t)=>{z(r=>r.sessionId===e&&r.runTag===t)},ve=e=>{z(t=>t.sessionId===e)},Ke=e=>{z(t=>t.runTag===e)},We=()=>{let e=o.length,t=l.length;e===0&&t===0||(R(13,e+t),o=[],l=[],I(18,0),G(),S("[PreScheduler] Cancelled all "+e+" events, "+t+" retries"),M())},Ze=e=>!e||e.length<8?!1:e[0]===35&&e[1]===98&&e[2]===117&&e[3]===110&&e[4]===100&&e[5]===108&&e[6]===101&&e[7]===0,qe=e=>{let t=[],r=new DataView(e.buffer,e.byteOffset,e.byteLength),s=16;for(;s+4<=e.length;){let n=r.getInt32(s,!1);if(s+=4,n<=0||n>Me||s+n>e.length)break;let c=e.slice(s,s+n);for(t.push(c),s+=n;s%4!==0&&s<e.length;)s++}return t},Xe=(e,t=0)=>{if(Ze(e)){let r=qe(e);for(let s=0;s<r.length;s++)h(r[s],!1,t,!0)||N(r[s],"immediate bundle message "+s,t)}else h(e,!1,t,!0)||N(e,"immediate message",t)};self.addEventListener("message",e=>{let{data:t}=e;try{switch(t.type){case"init":if(p=t.mode||"sab",t.maxPendingMessages&&(P=t.maxPendingMessages),t.snapshotIntervalMs&&(Z=t.snapshotIntervalMs),t.bypassLookaheadS!==void 0&&($=t.bypassLookaheadS),p==="sab")D=t.sharedBuffer,x=t.ringBufferBase,f=t.bufferConstants,Be(),f&&f.scheduler_slot_size&&(W=f.scheduler_slot_size);else{K=t.workletPort;let s=184;y=new ArrayBuffer(s),E=new Uint32Array(y),me()}F(14,Se),F(23,0),we(),S("[OSCPreSchedulerWorker] Initialized with NTP-based scheduling, mode="+p+", capacity="+P),self.postMessage({type:"initialized"});break;case"addOscSource":let r=e.ports[0];r&&(r.onmessage=s=>{s.data.type==="osc"&&s.data.oscData&&ae(s.data.oscData,0,"",s.data.sourceId||0)},S("[OSCPreSchedulerWorker] Added external OSC source"));break;case"send":ae(t.oscData,t.sessionId||0,t.runTag||"",t.sourceId||0);break;case"sendImmediate":Xe(t.oscData,t.sourceId||0);break;case"directDispatch":h(t.oscData,!1,t.sourceId||0,!0)||N(t.oscData,"directDispatch fallback",t.sourceId||0);break;case"cancelSessionTag":t.runTag!==void 0&&t.runTag!==null&&t.runTag!==""&&Qe(t.sessionId||0,t.runTag);break;case"cancelSession":ve(t.sessionId||0);break;case"cancelTag":t.runTag!==void 0&&t.runTag!==null&&t.runTag!==""&&Ke(t.runTag);break;case"cancelAll":We(),t.ack&&self.postMessage({type:"cancelAllAck"});break;default:}}catch(r){console.error("[OSCPreSchedulerWorker] Error:",r),self.postMessage({type:"error",error:r.message})}});S("[OSCPreSchedulerWorker] Script loaded");})();
