(()=>{function P({uint8View:o,dataView:e,bufferStart:t,bufferSize:s,head:N,tail:C,messageMagic:R,paddingMagic:U,headerSize:i,maxMessages:l=1/0,onMessage:r,onCorruption:S}){let E=C,x=0,p=H=>{let T=H;if(T+4<=s)return e.getUint32(t+T,!0);let A=0;for(let I=0;I<4;I++)A|=o[t+(T+I)%s]<<I*8;return A};for(;E!==N&&x<l;){let H=s-E,T;if(H>=4?T=e.getUint32(t+E,!0):T=p(E),T===U){E=0;continue}if(T!==R){S&&S(E),E=(E+1)%s;continue}let A=p((E+4)%s),I=p((E+8)%s),F=p((E+12)%s);if(A<i||A>s){S&&S(E),E=(E+1)%s;continue}let d=A-i,g=t+(E+i)%s;r(g,d,I,F),E=(E+A)%s,x++}return{newTail:E,messagesRead:x}}function u(o,e){let t=o+e;return{OUT_HEAD:(t+8)/4,OUT_TAIL:(t+12)/4}}var D=null,O=null,_=null,M=null,B=null,c=null,a={},n=null,L=!1,W=(...o)=>{},f=-1,Q=(o,e,t)=>{D=o,O=e,c=t,_=new Int32Array(D),M=new DataView(D),B=new Uint8Array(D),a=u(O,c.CONTROL_START);let s=O+c.METRICS_START;n=new Uint32Array(D,s,c.METRICS_SIZE/4)},k=()=>{let o=Atomics.load(_,a.OUT_HEAD),e=Atomics.load(_,a.OUT_TAIL);if(o===e)return[];let t=[],{newTail:s,messagesRead:N}=P({uint8View:B,dataView:M,bufferStart:O+c.OUT_BUFFER_START,bufferSize:c.OUT_BUFFER_SIZE,head:o,tail:e,messageMagic:c.MESSAGE_MAGIC,paddingMagic:c.PADDING_MAGIC,headerSize:c.MESSAGE_HEADER_SIZE,maxMessages:100,onMessage:(C,R,U,i)=>{if(f>=0){let r=f+1&4294967295;if(U!==r){let S=U-r+4294967296&4294967295;S<1e3&&(console.error("[OSCInWorker] Detected",S,"dropped messages (expected seq",r,"got",U,")"),n&&Atomics.add(n,28,S))}}f=U;let l=new Uint8Array(R);for(let r=0;r<R;r++)l[r]=B[C+r];t.push({oscData:l,sequence:U}),n&&(Atomics.add(n,26,1),Atomics.add(n,27,R))},onCorruption:C=>{console.error("[OSCInWorker] Corrupted message at position",C),n&&(Atomics.add(n,28,1),Atomics.add(n,29,1))}});return N>0&&Atomics.store(_,a.OUT_TAIL,s),t},K=()=>{for(;L;)try{let o=Atomics.load(_,a.OUT_HEAD),e=Atomics.load(_,a.OUT_TAIL);o===e&&Atomics.wait(_,a.OUT_HEAD,o);let t=k();t.length>0&&self.postMessage({type:"messages",messages:t})}catch(o){console.error("[OSCInWorker] Error in wait loop:",o),self.postMessage({type:"error",error:o.message}),Atomics.wait(_,0,_[0],10)}},V=()=>{if(!D){console.error("[OSCInWorker] Cannot start - not initialized");return}L||(L=!0,K())},b=()=>{L=!1};self.addEventListener("message",o=>{let{data:e}=o;try{switch(e.type){case"init":Q(e.sharedBuffer,e.ringBufferBase,e.bufferConstants),self.postMessage({type:"initialized"});break;case"start":V();break;case"stop":b();break;default:}}catch(t){console.error("[OSCInWorker] Error:",t),self.postMessage({type:"error",error:t.message})}});W("[OSCInWorker] Script loaded");})();
