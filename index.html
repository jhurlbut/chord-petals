<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
<title>ChordPetals</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#1a1222;--panel:#221832;--surface:rgba(255,255,255,0.06);--text:#e8e4f0;--text-dim:#8878a0;
  --major:#F2506E;--minor:#3DADD9;--dim:#32408C;--aug:#F27329;--dom7:#F23E2E;--halfdim:#32408C;--maj7:#F2506E;--min7:#3DADD9;
}
html,body{height:100%;overflow:hidden;font-family:'Luckiest Guy','SF Pro Display',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);
  user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;
  -webkit-touch-callout:none;
}
body{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;user-select:none;-webkit-user-select:none}

/* â”€â”€ Widget Container â”€â”€ */
.widget{
  width:100vw;max-width:500px;height:100vh;height:100dvh;
  background:var(--panel);border-radius:0;
  box-shadow:none;overflow:hidden;display:flex;flex-direction:column;
}

/* â”€â”€ Header â”€â”€ */
.widget-header{
  display:flex;align-items:center;justify-content:space-between;padding:10px 14px;
  border-bottom:1px solid rgba(255,255,255,0.06);
}
.widget-header .title{font-size:13px;font-weight:700;letter-spacing:0.5px}
.widget-header .palette{font-size:11px;color:var(--text-dim);margin-left:6px}
.header-actions{display:flex;align-items:center;gap:8px}
.header-actions button{
  background:none;border:none;color:var(--text-dim);font-size:15px;cursor:pointer;padding:2px;
  transition:color .2s;line-height:1;
}
.header-actions button:hover{color:var(--text)}
.header-actions button:disabled{opacity:0.3}

/* â”€â”€ Mode Selector â”€â”€ */
.mode-bar{
  display:flex;gap:3px;padding:8px 10px;overflow-x:auto;scrollbar-width:none;
  border-bottom:1px solid rgba(255,255,255,0.04);
}
.mode-bar::-webkit-scrollbar{display:none}
.mode-btn{
  flex-shrink:0;padding:5px 10px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);
  background:transparent;color:var(--text-dim);font-size:11px;font-weight:500;
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.mode-btn.active{background:rgba(242,80,110,0.2);border-color:rgba(242,80,110,0.4);color:#F2506E}

/* â”€â”€ History â”€â”€ */
.history{
  display:flex;gap:3px;align-items:center;padding:4px 12px;font-size:10px;color:var(--text-dim);
  overflow-x:auto;scrollbar-width:none;min-height:20px;
}
.history::-webkit-scrollbar{display:none}
.history span{cursor:pointer;opacity:0.6;transition:opacity .2s;white-space:nowrap}
.history span:hover{opacity:1}
.history span:last-child{opacity:1;color:var(--text)}
.history .arrow{opacity:0.3;cursor:default}

/* â”€â”€ Flower Garden â”€â”€ */
.garden{
  position:relative;width:100%;flex:1;min-height:0;overflow:hidden;
}

/* Outer rotation ring */
.rotation-ring{
  position:absolute;border-radius:50%;border:1.5px dashed rgba(255,255,255,0.1);
  pointer-events:auto;cursor:grab;
}
.rotation-ring:active{cursor:grabbing}

/* Delete zone ring â€” appears when dragging a petal */
.delete-ring{
  position:absolute;border-radius:50%;border:2px dashed rgba(242,80,110,0.0);
  pointer-events:none;transition:border-color .2s, box-shadow .2s;
  z-index:1;
}
.delete-ring.active{border-color:rgba(242,80,110,0.7);box-shadow:0 0 20px rgba(242,80,110,0.15)}
.delete-ring.danger{border-color:rgba(242,80,110,1);box-shadow:0 0 30px rgba(242,80,110,0.3);animation:pulse-ring .6s ease infinite alternate}
@keyframes pulse-ring{from{border-color:rgba(242,80,110,0.7)}to{border-color:rgba(242,80,110,1)}}

/* Center chord */
.center-chord{
  position:absolute;width:76px;height:76px;border-radius:50%;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:#32408C;border:none;
  z-index:10;cursor:pointer;transition:transform .15s,box-shadow .3s;
  left:50%;top:50%;transform:translate(-50%,-50%);
}
.center-chord:active{transform:translate(-50%,-50%) scale(0.93)}
.center-chord .name{font-size:22px;font-weight:700;line-height:1}
.center-chord .sub{font-size:9px;color:var(--text-dim);margin-top:1px}

/* Petals */
.petal{
  position:absolute;width:56px;height:56px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;z-index:5;
  transition:left .45s cubic-bezier(.4,0,.2,1),top .45s cubic-bezier(.4,0,.2,1),
             transform .15s,box-shadow .2s,width .15s,height .15s;
  transform:translate(-50%,-50%);
}
.petal.entering{opacity:0;transform:translate(-50%,-50%) scale(0.3)}
.petal .petal-label{
  font-size:12px;font-weight:700;color:#fff;text-shadow:none;
  pointer-events:none;text-align:center;line-height:1.1;
}
.petal-rings{position:absolute;top:0;left:0;pointer-events:none;border-radius:50%}
.petal.selected{box-shadow:0 0 0 3px rgba(255,255,255,0.5)!important}
.petal.dragging{
  width:62px;height:62px;z-index:20;
  box-shadow:none!important;
  transition:width .1s,height .1s,box-shadow .1s;
}

/* â”€â”€ +/- buttons â”€â”€ */
.petal-count{
  position:absolute;bottom:8px;right:8px;display:flex;gap:6px;z-index:25;
}
.petal-count button{
  width:36px;height:36px;border-radius:50%;border:1px solid rgba(255,255,255,0.25);
  background:rgba(255,255,255,0.12);color:var(--text);font-size:20px;line-height:1;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  touch-action:manipulation;-webkit-tap-highlight-color:rgba(255,255,255,0.1);
}
.petal-count button:active{background:rgba(255,255,255,0.3)}

/* â”€â”€ Bottom Toolbar â”€â”€ */
.toolbar{
  display:flex;align-items:center;justify-content:center;gap:16px;
  padding:8px 14px 10px;border-top:1px solid rgba(255,255,255,0.06);
}
.tool-btn{
  background:none;border:none;color:var(--text-dim);font-size:16px;cursor:pointer;
  padding:4px;transition:color .2s;position:relative;
}
.tool-btn:hover,.tool-btn.active{color:var(--text)}
.tool-btn.active::after{
  content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);
  width:4px;height:4px;border-radius:50%;background:var(--major);
}

/* â”€â”€ Key Selector Popup â”€â”€ */
.key-popup{
  position:absolute;z-index:50;background:#16162a;border-radius:14px;
  border:none;box-shadow:none;
  padding:10px;display:none;
  left:50%;top:50%;transform:translate(-50%,-50%);
}
.key-popup.show{display:grid;grid-template-columns:repeat(4,1fr);gap:4px}
.key-popup button{
  width:40px;height:36px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);
  background:rgba(255,255,255,0.06);color:var(--text);font-size:13px;font-weight:600;
  cursor:pointer;transition:all .15s;
}
.key-popup button:hover{background:rgba(242,80,110,0.25);border-color:rgba(242,80,110,0.5)}
.key-popup button.current{background:rgba(242,80,110,0.3);border-color:rgba(242,80,110,0.6)}

/* â”€â”€ MIDI Panel â”€â”€ */
.midi-panel{
  position:fixed;bottom:0;left:50%;transform:translate(-50%,100%);
  width:360px;max-width:96vw;background:rgba(16,16,30,0.97);
  border-top:1px solid rgba(255,255,255,0.1);padding:14px 16px 20px;
  transition:transform .3s ease;z-index:100;border-radius:14px 14px 0 0;
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
}
.midi-panel.open{transform:translate(-50%,0)}
.midi-panel h3{font-size:13px;font-weight:600;margin-bottom:10px}
.midi-panel label{display:block;font-size:11px;color:var(--text-dim);margin:6px 0 3px}
.midi-panel select{
  width:100%;padding:5px 7px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);
  background:rgba(255,255,255,0.06);color:var(--text);font-size:12px;outline:none;
}
.midi-row{display:flex;gap:10px}.midi-row>*{flex:1}
.midi-toggle{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-dim);cursor:pointer;margin-top:8px}
.midi-toggle input{display:none}
.midi-toggle .sw{
  width:32px;height:17px;border-radius:9px;background:rgba(255,255,255,0.1);position:relative;transition:background .2s;
}
.midi-toggle input:checked+.sw{background:rgba(242,80,110,0.5)}
.midi-toggle .sw::after{
  content:'';position:absolute;top:2px;left:2px;width:13px;height:13px;border-radius:50%;
  background:#fff;transition:transform .2s;
}
.midi-toggle input:checked+.sw::after{transform:translateX(15px)}
.midi-note{font-size:10px;color:var(--text-dim);margin-top:6px;opacity:0.6}
.voice-opt{flex:1;padding:6px 4px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.06);color:var(--text);font-size:11px;cursor:pointer;font-family:inherit}
.voice-opt.active{background:rgba(242,80,110,0.25);border-color:rgba(242,80,110,0.5)}
.midi-detected{font-size:10px;color:var(--min7);text-align:center;min-height:14px;padding:2px 0}
</style>
</head>
<body>

<div class="widget">
  <!-- Header -->
  <div class="widget-header">
    <div><span class="title">ChordPetals</span><span class="palette">Palette 1</span></div>
    <div class="header-actions">
      <button id="undoBtn" onclick="undoHistory()" title="Undo">â†©</button>
      <button id="redoBtn" onclick="redoHistory()" title="Redo" disabled>â†ª</button>
      <button onclick="toggleMidiPanel()" title="Settings">âš™</button>
    </div>
  </div>

  <!-- Mode bar -->
  <div class="mode-bar" id="modeBar"></div>

  <!-- History -->
  <div class="history" id="history"></div>

  <!-- MIDI detected -->
  <div class="midi-detected" id="midiDetected"></div>

  <!-- Flower garden -->
  <div class="garden" id="garden">
      <div class="rotation-ring" id="rotRing"></div>
      <div class="delete-ring" id="deleteRing"></div>
      <div class="center-chord" id="center">
        <div class="name" id="centerName">C</div>
        <div class="sub" id="centerSub">major</div>
      </div>
      <div class="key-popup" id="keyPopup"></div>
      <div class="petal-count">
        <button id="removeBtn">âˆ’</button>
        <span id="petalCountLabel" style="color:var(--text-dim);font-size:12px;display:flex;align-items:center">5</span>
        <button id="addBtn">+</button>
      </div>
  </div>
  <!-- Bottom toolbar -->
  <div class="toolbar">
    <button class="tool-btn active" id="eyeBtn" onclick="toggleNames()" title="Show/hide names">ğŸ‘</button>
    <button class="tool-btn" onclick="copyChords()" title="Copy chords">ğŸ“‹</button>
    <button class="tool-btn active" id="soundBtn" onclick="toggleSound()" title="Sound">ğŸ”Š</button>
    <button class="tool-btn" id="lockBtn" onclick="toggleLock()" title="Lock root">ğŸ”“</button>
    <button class="tool-btn" id="voiceBtn" onclick="toggleVoicePanel()" title="Voicing">ğŸ›</button>
    <button class="tool-btn" onclick="toggleMidiPanel()" title="MIDI">ğŸ¹</button>
  </div>
</div>

<!-- Voicing Panel -->
<div class="midi-panel" id="voicePanel">
  <h3>ğŸ› Voicing & Phrasing</h3>
  <label>Bass Root</label>
  <label class="midi-toggle"><input type="checkbox" id="bassToggle" onchange="toggleBass(this.checked)"><span class="sw"></span>Play root in bass octave</label>
  <label>Voicing</label>
  <div style="display:flex;gap:4px;margin-bottom:8px">
    <button class="voice-opt active" data-voice="close" onclick="setVoiceMode('close')">Close</button>
    <button class="voice-opt" data-voice="open" onclick="setVoiceMode('open')">Open</button>
    <button class="voice-opt" data-voice="spread" onclick="setVoiceMode('spread')">Spread</button>
  </div>
  <label>Phrasing</label>
  <div style="display:flex;gap:4px">
    <button class="voice-opt active" data-phrase="block" onclick="setPhraseMode('block')">Block</button>
    <button class="voice-opt" data-phrase="strum" onclick="setPhraseMode('strum')">Strum</button>
    <button class="voice-opt" data-phrase="arpeggio" onclick="setPhraseMode('arpeggio')">Arpeggio</button>
  </div>
</div>

<!-- MIDI Panel -->
<div class="midi-panel" id="midiPanel">
  <h3>ğŸ¹ MIDI Settings</h3>
  <label>MIDI Output</label>
  <select id="midiOut"><option value="">None</option></select>
  <label>MIDI Input</label>
  <select id="midiIn"><option value="">None</option></select>
  <div class="midi-row">
    <div><label>Channel</label><select id="midiCh"></select></div>
  </div>
  <label class="midi-toggle">Send MIDI on tap<input type="checkbox" id="midiSendToggle" checked><span class="sw"></span></label>
  <label class="midi-toggle">Auto-navigate on input<input type="checkbox" id="midiNavToggle"><span class="sw"></span></label>
  <div class="midi-note" id="midiNote"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MUSIC THEORY ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const NOTES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const FLAT_MAP = {'C#':'Db','D#':'Eb','F#':'Gb','G#':'Ab','A#':'Bb'};
const MAJOR_SCALE = [0,2,4,5,7,9,11];
const MINOR_SCALE = [0,2,3,5,7,8,10];

// Desaturate and darken a hex color for text
function desatColor(hex,sat=0.4,light=0.55){
  let r=parseInt(hex.slice(1,3),16)/255,g=parseInt(hex.slice(3,5),16)/255,b=parseInt(hex.slice(5,7),16)/255;
  const max=Math.max(r,g,b),min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min){h=s=0;}else{const d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break;}}
  s*=sat;l=light;
  function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}
  const q=l<0.5?l*(1+s):l+s-l*s,p=2*l-q;
  const ro=Math.round(hue2rgb(p,q,h+1/3)*255),go=Math.round(hue2rgb(p,q,h)*255),bo=Math.round(hue2rgb(p,q,h-1/3)*255);
  return `rgb(${ro},${go},${bo})`;
}
const QUALITY = {
  major:{intervals:[0,4,7],color:'var(--major)',solid:'#F2506E'},
  minor:{intervals:[0,3,7],color:'var(--minor)',solid:'#3DADD9'},
  dim:{intervals:[0,3,6],color:'var(--dim)',solid:'#32408C'},
  aug:{intervals:[0,4,8],color:'var(--aug)',solid:'#F27329'},
  dom7:{intervals:[0,4,7,10],color:'var(--dom7)',solid:'#F23E2E'},
  maj7:{intervals:[0,4,7,11],color:'var(--maj7)',solid:'#F2506E'},
  min7:{intervals:[0,3,7,10],color:'var(--min7)',solid:'#3DADD9'},
  halfdim:{intervals:[0,3,6,10],color:'var(--halfdim)',solid:'#32408C'},
};

// Voicing extensions: each ring level adds notes
// Level 0 = triad (3 notes), 1 = 7th (4), 2 = 9th (5), 3 = 11th (6)
const VOICING_EXTENSIONS = {
  major:  [[0,4,7],[0,4,7,11],[0,4,7,11,14],[0,4,7,11,14,17]],
  minor:  [[0,3,7],[0,3,7,10],[0,3,7,10,14],[0,3,7,10,14,17]],
  dim:    [[0,3,6],[0,3,6,9], [0,3,6,9,14], [0,3,6,9,14,17]],
  aug:    [[0,4,8],[0,4,8,11],[0,4,8,11,14],[0,4,8,11,14,18]],
  dom7:   [[0,4,7],[0,4,7,10],[0,4,7,10,14],[0,4,7,10,14,17]],
  maj7:   [[0,4,7],[0,4,7,11],[0,4,7,11,14],[0,4,7,11,14,17]],
  min7:   [[0,3,7],[0,3,7,10],[0,3,7,10,14],[0,3,7,10,14,17]],
  halfdim:[[0,3,6],[0,3,6,10],[0,3,6,10,14],[0,3,6,10,14,17]],
};
const VOICING_LABELS = ['','7','9','11'];

function noteName(idx, preferFlat=false){
  const n=NOTES[((idx%12)+12)%12];
  return preferFlat&&FLAT_MAP[n]?FLAT_MAP[n]:n;
}
function qualitySuffix(q){
  return {major:'',minor:'m',dim:'Â°',aug:'+',dom7:'7',maj7:'maj7',min7:'m7',halfdim:'Ã¸7'}[q]||'';
}
function chord(root,quality,numeral=''){
  return {root,quality,numeral,name:noteName(root,true)+qualitySuffix(quality)};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HARMONY MODES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODES = [
  {id:'diatonic',label:'Diatonic',fn:getDiatonic},
  {id:'fifths',label:'Circle of 5ths',fn:getCircleOfFifths},
  {id:'relative',label:'Relative/Parallel',fn:getRelativeParallel},
  {id:'tritone',label:'Tritone Subs',fn:getTritoneSubs},
  {id:'modal',label:'Modal Interchange',fn:getModalInterchange},
];

const SCALE_INTERVALS={
  major:[0,2,4,5,7,9,11],
  minor:[0,2,3,5,7,8,10],
  diminished:[0,2,3,5,6,8,9,11],
  lydian:[0,2,4,6,7,9,11],
};
const SCALE_QUALS={
  major:['major','minor','minor','major','major','minor','dim'],
  minor:['minor','dim','major','minor','minor','major','major'],
  diminished:['dim','dim','dim','dim','dim','dim','dim','dim'],
  lydian:['major','major','minor','dim','major','minor','minor'],
};
const SCALE_NUMS={
  major:['I','ii','iii','IV','V','vi','viiÂ°'],
  minor:['i','iiÂ°','III','iv','v','VI','VII'],
  diminished:['iÂ°','iiÂ°','iiiÂ°','ivÂ°','vÂ°','viÂ°','viiÂ°','viiiÂ°'],
  lydian:['I','II','iii','#ivÂ°','V','vi','vii'],
};
function getDiatonic(root){
  const sc=currentScale||'major';
  const intervals=SCALE_INTERVALS[sc]||SCALE_INTERVALS.major;
  const quals=SCALE_QUALS[sc]||SCALE_QUALS.major;
  const nums=SCALE_NUMS[sc]||SCALE_NUMS.major;
  return intervals.map((s,i)=>chord((root+s)%12,quals[i],nums[i]));
}
function getCircleOfFifths(root){
  const steps=[-7,-5,-2,0,2,5,7];
  const labels=['IV of IV','â™­VII','IV','I','V','II (V/V)','VI'];
  return steps.map((s,i)=>{const n=((root+s)%12+12)%12;return chord(n,'major',labels[i]);});
}
function getRelativeParallel(root){
  return [
    chord((root+9)%12,'minor','vi (rel min)'),chord((root+3)%12,'major','â™­III (rel maj of min)'),
    chord(root,'minor','i (parallel min)'),chord((root+5)%12,'major','IV'),
    chord((root+7)%12,'major','V'),chord((root+8)%12,'major','â™­VI (from min)'),
  ];
}
function getTritoneSubs(root){
  return [
    chord((root+6)%12,'dom7','â™­II7 (tritone sub)'),chord((root+7)%12,'dom7','V7'),
    chord((root+2)%12,'dom7','V7/V (sec dom)'),chord((root+9)%12,'dom7','V7/ii'),
    chord((root+4)%12,'dom7','V7/IV'),chord((root+11)%12,'dom7','V7/iii'),
    chord((root+1)%12,'dom7','â™­II7/V'),
  ];
}
function getModalInterchange(root){
  return [
    chord((root+3)%12,'major','â™­III (dorian)'),chord((root+5)%12,'minor','iv (aeolian)'),
    chord((root+8)%12,'major','â™­VI (aeolian)'),chord((root+10)%12,'major','â™­VII (mixolydian)'),
    chord((root+1)%12,'major','â™­II (phrygian)'),chord((root+6)%12,'dim','#ivÂ° (lydian)'),
    chord((root+3)%12,'minor','â™­iii (phrygian)'),
  ];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEB AUDIO â€” Supersaw Synth
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx=null,masterGain=null,reverbNode=null,activeVoices=[];

function getAudio(){
  if(!audioCtx){
    audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    masterGain=audioCtx.createGain();
    masterGain.gain.value=0.35;
    try{
      reverbNode=audioCtx.createConvolver();
      const len=audioCtx.sampleRate*1.5;
      const impulse=audioCtx.createBuffer(2,len,audioCtx.sampleRate);
      for(let ch=0;ch<2;ch++){const d=impulse.getChannelData(ch);for(let i=0;i<len;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/len,2.5);}
      reverbNode.buffer=impulse;
      const wetGain=audioCtx.createGain();wetGain.gain.value=0.15;
      const dryGain=audioCtx.createGain();dryGain.gain.value=0.85;
      masterGain.connect(dryGain).connect(audioCtx.destination);
      masterGain.connect(reverbNode).connect(wetGain).connect(audioCtx.destination);
    }catch(e){masterGain.connect(audioCtx.destination);}
  }
  return audioCtx;
}
// Resume audio after tab switch â€” needs user gesture on iOS
let audioNeedsRestart=false;
document.addEventListener('visibilitychange',()=>{
  if(document.visibilityState==='hidden'&&audioCtx){
    audioNeedsRestart=true;
  }
});
function resumeAudioCtx(){
  if(!audioCtx)return;
  if(audioCtx.state==='suspended'){
    audioCtx.resume().catch(()=>{});
  }
  // If returning from background, force recreate the audio context
  if(audioNeedsRestart){
    audioNeedsRestart=false;
    if(audioCtx.state==='suspended'){
      try{audioCtx.close();}catch(e){}
      audioCtx=null;masterGain=null;reverbNode=null;
      getAudio(); // recreate fresh
    }
  }
}
['touchstart','touchend','click','pointerdown','pointerup'].forEach(evt=>{
  document.addEventListener(evt,resumeAudioCtx,{passive:true});
});

function checkMuteState(){} // removed - was causing UI issues

// Apply voicing mode to intervals
function applyVoicing(intervals){
  let v=[...intervals];
  if(voicingMode==='open'&&v.length>=3){
    // Raise middle notes up an octave
    for(let i=1;i<v.length-1;i++) v[i]+=12;
  }else if(voicingMode==='spread'&&v.length>=3){
    // Spread across 2 octaves
    v=v.map((n,i)=>n+Math.floor(i*24/(v.length-1||1))-Math.floor(i*12/(v.length-1||1)));
  }
  return v;
}

// Play a single note with the synth engine
function playNote(ctx,freq,startTime,gain,duration){
  const attack=0.02,decay=0.15,sustain=0.6,release=Math.min(1.0,duration*0.5);
  const total=duration;
  const vGain=ctx.createGain();
  vGain.gain.setValueAtTime(0.001,startTime);
  vGain.gain.linearRampToValueAtTime(gain,startTime+attack);
  vGain.gain.linearRampToValueAtTime(gain*sustain,startTime+attack+decay);
  vGain.gain.setValueAtTime(gain*sustain,startTime+total-release);
  vGain.gain.exponentialRampToValueAtTime(0.001,startTime+total);
  const filter=ctx.createBiquadFilter();filter.type='lowpass';
  filter.frequency.setValueAtTime(2200,startTime);filter.frequency.exponentialRampToValueAtTime(800,startTime+total*0.7);filter.Q.value=1.5;
  const saw1=ctx.createOscillator();saw1.type='sawtooth';saw1.frequency.value=freq;
  const saw2=ctx.createOscillator();saw2.type='sawtooth';saw2.frequency.value=freq*1.005;
  const saw3=ctx.createOscillator();saw3.type='sawtooth';saw3.frequency.value=freq*0.995;
  const sub=ctx.createOscillator();sub.type='triangle';sub.frequency.value=freq/2;
  const subGain=ctx.createGain();subGain.gain.value=0.3;
  const m1=ctx.createGain();m1.gain.value=0.4;const m2=ctx.createGain();m2.gain.value=0.3;const m3=ctx.createGain();m3.gain.value=0.3;
  saw1.connect(m1);saw2.connect(m2);saw3.connect(m3);sub.connect(subGain);
  m1.connect(filter);m2.connect(filter);m3.connect(filter);subGain.connect(filter);
  filter.connect(vGain);vGain.connect(masterGain);
  saw1.start(startTime);saw1.stop(startTime+total+0.1);
  saw2.start(startTime);saw2.stop(startTime+total+0.1);
  saw3.start(startTime);saw3.stop(startTime+total+0.1);
  sub.start(startTime);sub.stop(startTime+total+0.1);
  activeVoices.push({gain:vGain,stop:(t)=>{[saw1,saw2,saw3,sub].forEach(o=>{try{o.stop(t)}catch(e){}})}});
}

function playChordNotes(rootNote,intervals){
  if(!soundOn)return;
  checkMuteState();
  const ctx=getAudio();if(ctx.state==='suspended')ctx.resume();
  const baseFreq=261.63*Math.pow(2,rootNote/12);
  const voiced=applyVoicing(intervals);
  const now=ctx.currentTime;
  activeVoices.forEach(v=>{try{v.gain.gain.cancelScheduledValues(now);v.gain.gain.setValueAtTime(v.gain.gain.value,now);v.gain.gain.exponentialRampToValueAtTime(0.001,now+0.05);v.stop(now+0.06);}catch(e){}});
  activeVoices=[];
  const noteGain=0.12/voiced.length;
  const total=phraseMode==='arpeggio'?2.4:1.8;
  // Play bass root note separately with boosted volume and sine wave
  if(bassRoot){
    const bassFreq=baseFreq*Math.pow(2,-24/12); // 2 octaves down
    const bassGain=ctx.createGain();
    const bassAttack=0.01,bassDur=total+0.5;
    bassGain.gain.setValueAtTime(0.001,now);
    bassGain.gain.linearRampToValueAtTime(0.18,now+bassAttack);
    bassGain.gain.setValueAtTime(0.15,now+bassDur*0.6);
    bassGain.gain.exponentialRampToValueAtTime(0.001,now+bassDur);
    const bassOsc=ctx.createOscillator();bassOsc.type='sine';bassOsc.frequency.value=bassFreq;
    const bassOsc2=ctx.createOscillator();bassOsc2.type='triangle';bassOsc2.frequency.value=bassFreq;
    const mix1=ctx.createGain();mix1.gain.value=0.6;
    const mix2=ctx.createGain();mix2.gain.value=0.4;
    bassOsc.connect(mix1);bassOsc2.connect(mix2);
    mix1.connect(bassGain);mix2.connect(bassGain);
    bassGain.connect(masterGain);
    bassOsc.start(now);bassOsc.stop(now+bassDur+0.1);
    bassOsc2.start(now);bassOsc2.stop(now+bassDur+0.1);
    activeVoices.push({gain:bassGain,stop:(t)=>{try{bassOsc.stop(t);bassOsc2.stop(t);}catch(e){}}});
  }
  // Play chord notes
  voiced.forEach((semi,i)=>{
    const freq=baseFreq*Math.pow(2,semi/12);
    const delay=phraseMode==='strum'?i*0.03:phraseMode==='arpeggio'?i*0.15:0;
    const dur=phraseMode==='arpeggio'?total-delay:total;
    playNote(ctx,freq,now+delay,noteGain,dur);
  });
}

function playChord(rootNote,quality){
  if(!soundOn)return;
  const intervals=QUALITY[quality]?.intervals||[0,4,7];
  playChordNotes(rootNote,intervals);
}

function _playChord_UNUSED(rootNote,quality){
  if(!soundOn)return;
  checkMuteState();
  const ctx=getAudio();if(ctx.state==='suspended')ctx.resume();
  const baseFreq=261.63*Math.pow(2,rootNote/12);
  const intervals=QUALITY[quality]?.intervals||[0,4,7];
  const now=ctx.currentTime;
  activeVoices.forEach(v=>{try{v.gain.gain.cancelScheduledValues(now);v.gain.gain.setValueAtTime(v.gain.gain.value,now);v.gain.gain.exponentialRampToValueAtTime(0.001,now+0.05);v.stop(now+0.06);}catch(e){}});
  activeVoices=[];
  const noteGain=0.12/intervals.length;
  const attack=0.02,decay=0.15,sustain=0.6,release=1.0,total=1.8;
  intervals.forEach((semi)=>{
    const freq=baseFreq*Math.pow(2,semi/12);
    const vGain=ctx.createGain();
    vGain.gain.setValueAtTime(0.001,now);
    vGain.gain.linearRampToValueAtTime(noteGain,now+attack);
    vGain.gain.linearRampToValueAtTime(noteGain*sustain,now+attack+decay);
    vGain.gain.setValueAtTime(noteGain*sustain,now+total-release);
    vGain.gain.exponentialRampToValueAtTime(0.001,now+total);
    const filter=ctx.createBiquadFilter();filter.type='lowpass';
    filter.frequency.setValueAtTime(2200,now);filter.frequency.exponentialRampToValueAtTime(800,now+total*0.7);filter.Q.value=1.5;
    const saw1=ctx.createOscillator();saw1.type='sawtooth';saw1.frequency.value=freq;
    const saw2=ctx.createOscillator();saw2.type='sawtooth';saw2.frequency.value=freq*1.005;
    const saw3=ctx.createOscillator();saw3.type='sawtooth';saw3.frequency.value=freq*0.995;
    const sub=ctx.createOscillator();sub.type='triangle';sub.frequency.value=freq/2;
    const subGain=ctx.createGain();subGain.gain.value=0.3;
    const m1=ctx.createGain();m1.gain.value=0.4;
    const m2=ctx.createGain();m2.gain.value=0.3;
    const m3=ctx.createGain();m3.gain.value=0.3;
    saw1.connect(m1);saw2.connect(m2);saw3.connect(m3);sub.connect(subGain);
    m1.connect(filter);m2.connect(filter);m3.connect(filter);subGain.connect(filter);
    filter.connect(vGain);vGain.connect(masterGain);
    saw1.start(now);saw1.stop(now+total+0.1);
    saw2.start(now);saw2.stop(now+total+0.1);
    saw3.start(now);saw3.stop(now+total+0.1);
    sub.start(now);sub.stop(now+total+0.1);
    activeVoices.push({gain:vGain,stop:(t)=>{[saw1,saw2,saw3,sub].forEach(o=>{try{o.stop(t)}catch(e){}})}});
  });
}

// Play chord with explicit interval array
function playChordIntervals(rootNote,intervals){
  playChordNotes(rootNote,intervals);
}

function _playChordIntervals_UNUSED(rootNote,intervals){
  if(!soundOn)return;
  const ctx=getAudio();if(ctx.state==='suspended')ctx.resume();
  const baseFreq=261.63*Math.pow(2,rootNote/12);
  const now=ctx.currentTime;
  activeVoices.forEach(v=>{try{v.gain.gain.cancelScheduledValues(now);v.gain.gain.setValueAtTime(v.gain.gain.value,now);v.gain.gain.exponentialRampToValueAtTime(0.001,now+0.05);v.stop(now+0.06);}catch(e){}});
  activeVoices=[];
  const noteGain=0.12/intervals.length;
  const attack=0.02,decay=0.15,sustain=0.6,release=1.0,total=1.8;
  intervals.forEach((semi)=>{
    const freq=baseFreq*Math.pow(2,semi/12);
    const vGain=ctx.createGain();
    vGain.gain.setValueAtTime(0.001,now);
    vGain.gain.linearRampToValueAtTime(noteGain,now+attack);
    vGain.gain.linearRampToValueAtTime(noteGain*sustain,now+attack+decay);
    vGain.gain.setValueAtTime(noteGain*sustain,now+total-release);
    vGain.gain.exponentialRampToValueAtTime(0.001,now+total);
    const filter=ctx.createBiquadFilter();filter.type='lowpass';
    filter.frequency.setValueAtTime(2200,now);filter.frequency.exponentialRampToValueAtTime(800,now+total*0.7);filter.Q.value=1.5;
    const saw1=ctx.createOscillator();saw1.type='sawtooth';saw1.frequency.value=freq;
    const saw2=ctx.createOscillator();saw2.type='sawtooth';saw2.frequency.value=freq*1.005;
    const saw3=ctx.createOscillator();saw3.type='sawtooth';saw3.frequency.value=freq*0.995;
    const sub=ctx.createOscillator();sub.type='triangle';sub.frequency.value=freq/2;
    const subGain=ctx.createGain();subGain.gain.value=0.3;
    const m1=ctx.createGain();m1.gain.value=0.4;const m2=ctx.createGain();m2.gain.value=0.3;const m3=ctx.createGain();m3.gain.value=0.3;
    saw1.connect(m1);saw2.connect(m2);saw3.connect(m3);sub.connect(subGain);
    m1.connect(filter);m2.connect(filter);m3.connect(filter);subGain.connect(filter);
    filter.connect(vGain);vGain.connect(masterGain);
    saw1.start(now);saw1.stop(now+total+0.1);saw2.start(now);saw2.stop(now+total+0.1);
    saw3.start(now);saw3.stop(now+total+0.1);sub.start(now);sub.stop(now+total+0.1);
    activeVoices.push({gain:vGain,stop:(t)=>{[saw1,saw2,saw3,sub].forEach(o=>{try{o.stop(t)}catch(e){}})}});
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentRoot=0;
let currentMode='diatonic';
let currentScale='major'; // major, minor, diminished, lydian
const SCALE_TYPES=['major','minor','diminished','lydian'];
let history_stack=[{root:0,name:'C'}];
let redoStack=[];
let selectedPetal=-1;
let showNames=true;
let soundOn=true;
let lockRoot=false;
// Voicing & phrasing options
let bassRoot=false;      // play root in bass octave
let voicingMode='close'; // close, open, spread
let phraseMode='block';  // block, strum, arpeggio
const VOICING_MODES=['close','open','spread'];
const PHRASE_MODES=['block','strum','arpeggio'];
let petalCount=5; // default visible petals
let globalRotation=0; // degrees offset from dragging outer ring
let petalElements=[];
let petalCustomOffsets={}; // index -> {dx,dy} for dragged petals
let petalVoicings={}; // index -> 0-3 (ring level: triad, 7th, 9th, 11th)

function init(){
  const bar=document.getElementById('modeBar');
  MODES.forEach(m=>{
    const btn=document.createElement('button');
    btn.className='mode-btn'+(m.id===currentMode?' active':'');
    btn.textContent=m.label;
    btn.onclick=()=>setMode(m.id);
    btn.dataset.mode=m.id;
    bar.appendChild(btn);
  });
  buildKeyPopup();
  buildMidiChannels();
  render();
  initDragSystem();
}

function setMode(id){
  currentMode=id;
  document.querySelectorAll('.mode-btn').forEach(b=>b.classList.toggle('active',b.dataset.mode===id));
  petalCustomOffsets={};
  render();
}

function setRoot(noteIdx,name){
  redoStack=[];
  history_stack.push({root:noteIdx,name});
  if(history_stack.length>12)history_stack=history_stack.slice(-12);
  currentRoot=noteIdx;
  petalCustomOffsets={};
  selectedPetal=-1;
  render();
}

function undoHistory(){
  if(history_stack.length<=1)return;
  redoStack.push(history_stack.pop());
  const prev=history_stack[history_stack.length-1];
  currentRoot=prev.root;
  petalCustomOffsets={};selectedPetal=-1;
  render();
}
function redoHistory(){
  if(!redoStack.length)return;
  const next=redoStack.pop();
  history_stack.push(next);
  currentRoot=next.root;
  petalCustomOffsets={};selectedPetal=-1;
  render();
}

// Toolbar toggles
function toggleNames(){showNames=!showNames;document.getElementById('eyeBtn').classList.toggle('active',showNames);render();}
function toggleSound(){soundOn=!soundOn;document.getElementById('soundBtn').classList.toggle('active',soundOn);document.getElementById('soundBtn').textContent=soundOn?'ğŸ”Š':'ğŸ”‡';}
function toggleLock(){lockRoot=!lockRoot;document.getElementById('lockBtn').classList.toggle('active',lockRoot);document.getElementById('lockBtn').textContent=lockRoot?'ğŸ”’':'ğŸ”“';}
function copyChords(){
  const mode=MODES.find(m=>m.id===currentMode);
  const chords=mode.fn(currentRoot).slice(0,petalCount);
  const txt=chords.map(c=>c.name).join(' - ');
  navigator.clipboard?.writeText(txt);
}

function addPetal(){
  petalCount=Math.min(12,petalCount+1);
  document.getElementById('petalCountLabel').textContent=petalCount;
  render();
}
function removePetal(){
  petalCount=Math.max(3,petalCount-1);
  if(selectedPetal>=petalCount)selectedPetal=-1;
  document.getElementById('petalCountLabel').textContent=petalCount;
  render();
}

// Key selector popup
function buildKeyPopup(){
  const popup=document.getElementById('keyPopup');
  NOTES.forEach((n,i)=>{
    const btn=document.createElement('button');
    btn.textContent=noteName(i,true);
    btn.onclick=(e)=>{e.stopPropagation();popup.classList.remove('show');setRoot(i,noteName(i,true));};
    popup.appendChild(btn);
  });
}
function showKeyPopup(){
  const popup=document.getElementById('keyPopup');
  popup.querySelectorAll('button').forEach((b,i)=>b.classList.toggle('current',i===currentRoot));
  popup.classList.add('show');
}

// Swipe up/down on center to change scale
let centerTouchStartY=null;
document.getElementById('center').addEventListener('touchstart',(e)=>{
  centerTouchStartY=e.touches[0].clientY;
},{passive:true});
document.getElementById('center').addEventListener('touchend',(e)=>{
  if(centerTouchStartY===null)return;
  const dy=e.changedTouches[0].clientY-centerTouchStartY;
  centerTouchStartY=null;
  if(Math.abs(dy)<20)return; // too small, treat as tap
  e.preventDefault();e.stopPropagation();
  const idx=SCALE_TYPES.indexOf(currentScale);
  if(dy<0){// swipe up = next
    currentScale=SCALE_TYPES[(idx+1)%SCALE_TYPES.length];
  }else{// swipe down = prev
    currentScale=SCALE_TYPES[(idx-1+SCALE_TYPES.length)%SCALE_TYPES.length];
  }
  petalCustomOffsets={};selectedPetal=-1;
  render();
});
// Mouse wheel on center also changes scale (desktop)
document.getElementById('center').addEventListener('wheel',(e)=>{
  e.preventDefault();
  const idx=SCALE_TYPES.indexOf(currentScale);
  currentScale=SCALE_TYPES[(idx+(e.deltaY>0?1:-1)+SCALE_TYPES.length)%SCALE_TYPES.length];
  petalCustomOffsets={};selectedPetal=-1;
  render();
},{passive:false});

// Center click â€” play chord only
document.getElementById('center').addEventListener('click',(e)=>{
  e.stopPropagation();
  playChord(currentRoot,'major');
  sendMIDIChord(currentRoot,'major');
  const el=document.getElementById('center');
  el.style.transform='translate(-50%,-50%) scale(1.08)';
  setTimeout(()=>el.style.transform='translate(-50%,-50%)',150);
});
// Long-press center to show key selector
let centerLongPressT=null;
document.getElementById('center').addEventListener('pointerdown',(e)=>{
  centerLongPressT=setTimeout(()=>{showKeyPopup();centerLongPressT=null;},500);
});
document.getElementById('center').addEventListener('pointerup',()=>{if(centerLongPressT)clearTimeout(centerLongPressT);});
document.getElementById('center').addEventListener('pointermove',()=>{if(centerLongPressT)clearTimeout(centerLongPressT);});
// Close key popup on outside click
document.addEventListener('click',(e)=>{
  if(e.target.closest('.key-popup')||e.target.closest('.center-chord'))return;
  document.getElementById('keyPopup').classList.remove('show');
});

// Tap empty space in garden to add a petal
function gardenEmptyTap(e){
  if(e.target.closest('.petal')||e.target.closest('.center-chord')||e.target.closest('.rotation-ring')||e.target.closest('.key-popup')||e.target.closest('.petal-count')||e.target.closest('.delete-ring')||e.target.closest('.midi-panel')||e.target.closest('#voicePanel')||e.target.closest('.tool-btn')||e.target.closest('.toolbar'))return;
  // Don't add petal if we just closed a panel
  const midiPanel=document.getElementById('midiPanel');
  const voicePanel=document.getElementById('voicePanel');
  if(midiPanel._justClosed||voicePanel._justClosed){delete midiPanel._justClosed;delete voicePanel._justClosed;return;}
  addPetal();
}
document.getElementById('garden').addEventListener('click',gardenEmptyTap);

function render(){
  const mode=MODES.find(m=>m.id===currentMode);
  let allChords=mode.fn(currentRoot);
  // If petalCount exceeds mode's chords, pad with chromatic neighbors
  while(allChords.length<petalCount){
    const next=(currentRoot+allChords.length)%12;
    allChords.push(chord(next,'major','+')); 
  }
  const chords=allChords.slice(0,petalCount);
  const rootName=noteName(currentRoot,true);

  document.getElementById('centerName').textContent=rootName;
  document.getElementById('centerSub').textContent=currentScale;

  document.getElementById('undoBtn').disabled=history_stack.length<=1;
  document.getElementById('redoBtn').disabled=redoStack.length===0;

  // Render petals
  const garden=document.getElementById('garden');
  const gw=garden.clientWidth||360;
  const gh=garden.clientHeight||360;
  const cx=gw/2, cy=gh/2;

  // Scale petals to garden size
  const scale=Math.min(gw,gh)/300;
  const centerR=Math.round(48*scale), petalR=Math.round(36*scale);

  // Scale center circle
  const cEl=document.getElementById('center');
  cEl.style.width=(centerR*2)+'px';cEl.style.height=(centerR*2)+'px';
  document.getElementById('centerName').style.fontSize=Math.round(centerR*0.55)+'px';
  document.getElementById('centerSub').style.fontSize=Math.round(centerR*0.2)+'px';
  const orbitR=centerR+petalR-Math.round(12*scale); // tight overlap

  // Rotation ring
  const ring=document.getElementById('rotRing');
  const ringR=orbitR+petalR+14;
  ring.style.width=ring.style.height=(ringR*2)+'px';
  ring.style.left=(cx-ringR)+'px';ring.style.top=(cy-ringR)+'px';

  // Delete ring (same size as rotation ring)
  const delRing=document.getElementById('deleteRing');
  delRing.style.width=delRing.style.height=(ringR*2)+'px';
  delRing.style.left=(cx-ringR)+'px';delRing.style.top=(cy-ringR)+'px';

  // Remove old petals
  petalElements.forEach(el=>el.remove());
  petalElements=[];

  chords.forEach((ch,i)=>{
    const angle=(2*Math.PI*i/chords.length)-Math.PI/2+(globalRotation*Math.PI/180);
    const custom=petalCustomOffsets[i];
    const px=custom?cx+custom.dx:cx+orbitR*Math.cos(angle);
    const py=custom?cy+custom.dy:cy+orbitR*Math.sin(angle);
    const qi=QUALITY[ch.quality]||QUALITY.major;

    const voiceLevel=petalVoicings[i]||0;
    const el=document.createElement('div');
    el.className='petal';
    el.style.left=px+'px';el.style.top=py+'px';
    el.style.width=(petalR*2)+'px';el.style.height=(petalR*2)+'px';
    el.style.background=qi.solid;
    el.style.boxShadow='none';
    if(i===selectedPetal)el.classList.add('selected');

    // Build concentric rings SVG overlay
    let ringsHTML='';
    const pDiam=petalR*2;
    if(voiceLevel>0){
      ringsHTML=`<svg class="petal-rings" viewBox="0 0 ${pDiam} ${pDiam}" width="${pDiam}" height="${pDiam}">`;
      for(let r=1;r<=voiceLevel;r++){
        const ringR=petalR-r*(petalR/5);
        ringsHTML+=`<circle cx="${petalR}" cy="${petalR}" r="${ringR}" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.5"/>`;
      }
      ringsHTML+='</svg>';
    }
    // Voicing label suffix
    const vLabel=VOICING_LABELS[voiceLevel]||'';
    const displayName=showNames?(ch.name.replace(/(m7|7|maj7|Ã¸7)$/,'')+vLabel|| ch.name):'';
    const voiceTag=voiceLevel>0?` ${['','7th','9th','11th'][voiceLevel]}`:'';
    const noteCount=voiceLevel>0?[3,4,5,6][voiceLevel]+'â™ª':'';
    const fontSize=Math.max(11,Math.round(petalR*0.38));
    el.innerHTML=`${ringsHTML}<span class="petal-label" style="font-size:${fontSize}px">${showNames?ch.name+voiceTag:noteCount}</span>`;
    el.dataset.index=i;

    // Click
    el.addEventListener('click',(e)=>{
      if(el._wasDragged)return;
      e.stopPropagation();
      selectedPetal=i===selectedPetal?-1:i;
      // Use voicing-extended intervals
      const vl=petalVoicings[i]||0;
      const ext=VOICING_EXTENSIONS[ch.quality];
      if(ext&&ext[vl]){
        playChordIntervals(ch.root,ext[vl]);
      }else{
        playChord(ch.root,ch.quality);
      }
      sendMIDIChord(ch.root,ch.quality);
      // Spring animation
      el.style.transition='transform 0.1s ease-out';
      el.style.transform='translate(-50%,-50%) scale(0.88)';
      setTimeout(()=>{el.style.transition='transform 0.3s cubic-bezier(0.34,1.56,0.64,1)';el.style.transform='translate(-50%,-50%) scale(1.06)';},100);
      setTimeout(()=>{el.style.transition='transform 0.25s cubic-bezier(0.34,1.2,0.64,1)';el.style.transform='translate(-50%,-50%) scale(0.97)';},350);
      setTimeout(()=>{el.style.transition='transform 0.2s ease-out';el.style.transform='translate(-50%,-50%)';render();},550);
    });

    // Double-tap to navigate, long-press to cycle voicing
    let tapC=0,tapT,longPressT;
    el.addEventListener('pointerdown',(ev)=>{
      tapC++;
      if(tapC===2){
        clearTimeout(tapT);tapC=0;
        if(!lockRoot){setRoot(ch.root,ch.name);}
        else{delete petalCustomOffsets[i];render();}
        return;
      }
      tapT=setTimeout(()=>tapC=0,350);
      // Long press: cycle voicing rings
      longPressT=setTimeout(()=>{
        const cur=petalVoicings[i]||0;
        petalVoicings[i]=(cur+1)%4;
        el._wasDragged=true; // prevent click from firing
        render();
        // Play the new voicing
        const vl2=petalVoicings[i];
        const ext2=VOICING_EXTENSIONS[ch.quality];
        if(ext2&&ext2[vl2])playChordIntervals(ch.root,ext2[vl2]);
      },500);
    });
    el.addEventListener('pointerup',()=>clearTimeout(longPressT));
    el.addEventListener('pointermove',()=>clearTimeout(longPressT));

    garden.appendChild(el);
    petalElements.push(el);
  });

  // History
  const hEl=document.getElementById('history');
  hEl.innerHTML='';
  history_stack.forEach((h,i)=>{
    if(i>0){const a=document.createElement('span');a.className='arrow';a.textContent=' â†’ ';hEl.appendChild(a);}
    const s=document.createElement('span');s.textContent=h.name;
    s.onclick=()=>{currentRoot=h.root;history_stack=history_stack.slice(0,i+1);redoStack=[];petalCustomOffsets={};selectedPetal=-1;render();};
    hEl.appendChild(s);
  });
  hEl.scrollLeft=hEl.scrollWidth;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG SYSTEM (petals + rotation ring)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initDragSystem(){
  const garden=document.getElementById('garden');
  let dragTarget=null,dragType=null,startX,startY,startAngle;

  function getPos(e){const t=e.touches?e.touches[0]:e;return{x:t.clientX,y:t.clientY};}
  function gardenRect(){return garden.getBoundingClientRect();}

  // Petal drag
  garden.addEventListener('pointerdown',(e)=>{
    // Don't intercept +/- buttons
    if(e.target.closest('.petal-count'))return;
    const petal=e.target.closest('.petal');
    const ring=e.target.closest('.rotation-ring');
    if(petal){
      dragTarget=petal;dragType='petal';
      petal._wasDragged=false;
      const p=getPos(e);startX=p.x;startY=p.y;
      petal.classList.add('dragging');
      petal.setPointerCapture(e.pointerId);
      e.preventDefault();
    }else if(ring){
      dragType='ring';dragTarget=ring;
      const p=getPos(e);const r=gardenRect();
      const cx=r.left+r.width/2,cy=r.top+r.height/2;
      startAngle=Math.atan2(p.y-cy,p.x-cx)*180/Math.PI-globalRotation;
      ring.setPointerCapture(e.pointerId);
      e.preventDefault();
    }
  });

  garden.addEventListener('pointermove',(e)=>{
    if(!dragTarget)return;
    e.preventDefault();
    const p=getPos(e);
    if(dragType==='petal'){
      const dx=p.x-startX,dy=p.y-startY;
      if(Math.abs(dx)+Math.abs(dy)>5)dragTarget._wasDragged=true;
      const r=gardenRect();
      const cx=r.width/2,cy=r.height/2;
      const rect=gardenRect();
      const lx=p.x-rect.left,ly=p.y-rect.top;
      dragTarget.style.left=lx+'px';dragTarget.style.top=ly+'px';
      dragTarget.style.transition='width .1s,height .1s,box-shadow .1s';
      const idx=parseInt(dragTarget.dataset.index);
      petalCustomOffsets[idx]={dx:lx-cx,dy:ly-cy};
      // Show delete ring and check if outside
      const delRing=document.getElementById('deleteRing');
      const dist=Math.sqrt((lx-cx)**2+(ly-cy)**2);
      const ringR=parseFloat(delRing.style.width)/2;
      delRing.classList.add('active');
      if(dist>ringR){delRing.classList.add('danger');dragTarget.style.opacity='0.5';}
      else{delRing.classList.remove('danger');dragTarget.style.opacity='1';}
    }else if(dragType==='ring'){
      const r=gardenRect();
      const cx=r.left+r.width/2,cy=r.top+r.height/2;
      const angle=Math.atan2(p.y-cy,p.x-cx)*180/Math.PI;
      globalRotation=angle-startAngle;
      render();
    }
  });

  garden.addEventListener('pointerup',(e)=>{
    const delRing=document.getElementById('deleteRing');
    delRing.classList.remove('active','danger');
    if(dragTarget&&dragType==='petal'){
      dragTarget.classList.remove('dragging');
      dragTarget.style.transition='';
      dragTarget.style.opacity='1';
      // Check if outside delete ring â†’ remove petal
      const r=gardenRect();
      const cx=r.width/2,cy=r.height/2;
      const p=getPos(e);
      const lx=p.x-r.left,ly=p.y-r.top;
      const dist=Math.sqrt((lx-cx)**2+(ly-cy)**2);
      const ringR=parseFloat(delRing.style.width)/2;
      if(dragTarget._wasDragged&&dist>ringR&&petalCount>3){
        const idx=parseInt(dragTarget.dataset.index);
        delete petalCustomOffsets[idx];
        petalCount=Math.max(3,petalCount-1);
        render();
      }else{
        // Snap back if not deleted
        const idx=parseInt(dragTarget.dataset.index);
        if(dragTarget._wasDragged){delete petalCustomOffsets[idx];render();}
      }
    }
    dragTarget=null;dragType=null;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MIDI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let midiAccess=null,midiOutPort=null,midiInPort=null;
let midiActiveNotes=new Set(),midiHeldNotes=new Set(),midiNoteOffTimers={};

function toggleVoicePanel(){
  document.getElementById('voicePanel').classList.toggle('open');
  document.getElementById('midiPanel').classList.remove('open');
}
function toggleBass(v){bassRoot=v;}
function setVoiceMode(m){
  voicingMode=m;
  document.querySelectorAll('[data-voice]').forEach(b=>b.classList.toggle('active',b.dataset.voice===m));
}
function setPhraseMode(m){
  phraseMode=m;
  document.querySelectorAll('[data-phrase]').forEach(b=>b.classList.toggle('active',b.dataset.phrase===m));
}
function toggleMidiPanel(){document.getElementById('midiPanel').classList.toggle('open');document.getElementById('voicePanel').classList.remove('open');}
function closeMidiPanel(){
  const panel=document.getElementById('midiPanel');
  panel.classList.remove('open');
  panel._justClosed=true;
  setTimeout(()=>{delete panel._justClosed;},300);
}
document.addEventListener('pointerdown',(e)=>{
  const panel=document.getElementById('midiPanel');
  if(panel.classList.contains('open')&&!panel.contains(e.target)&&!e.target.closest('[onclick*="toggleMidiPanel"]')){
    closeMidiPanel();
  }
  const vPanel=document.getElementById('voicePanel');
  if(vPanel.classList.contains('open')&&!vPanel.contains(e.target)&&!e.target.closest('[onclick*="toggleVoicePanel"]')){
    vPanel.classList.remove('open');
    vPanel._justClosed=true;setTimeout(()=>{delete vPanel._justClosed;},300);
  }
});
function buildMidiChannels(){const s=document.getElementById('midiCh');for(let i=1;i<=16;i++){const o=document.createElement('option');o.value=i;o.textContent='Ch '+i;s.appendChild(o);}}

async function initMIDI(){
  if(!navigator.requestMIDIAccess)return;
  try{
    midiAccess=await navigator.requestMIDIAccess({sysex:false});
    populateMIDIDevices();
    midiAccess.onstatechange=()=>populateMIDIDevices();
  }catch(e){}
}

function populateMIDIDevices(){
  const outSel=document.getElementById('midiOut'),inSel=document.getElementById('midiIn');
  const prevOut=outSel.value,prevIn=inSel.value;
  outSel.innerHTML='<option value="">None</option>';
  inSel.innerHTML='<option value="">None</option>';
  for(const[id,port]of midiAccess.outputs){const o=document.createElement('option');o.value=id;o.textContent=port.name;outSel.appendChild(o);}
  for(const[id,port]of midiAccess.inputs){const o=document.createElement('option');o.value=id;o.textContent=port.name;inSel.appendChild(o);}
  if(prevOut)outSel.value=prevOut;if(prevIn)inSel.value=prevIn;
  selectMIDIOut();selectMIDIIn();
}

document.getElementById('midiOut').addEventListener('change',selectMIDIOut);
document.getElementById('midiIn').addEventListener('change',selectMIDIIn);

function selectMIDIOut(){const id=document.getElementById('midiOut').value;midiOutPort=id&&midiAccess?midiAccess.outputs.get(id):null;}
function selectMIDIIn(){
  if(midiInPort)midiInPort.onmidimessage=null;
  const id=document.getElementById('midiIn').value;
  midiInPort=id&&midiAccess?midiAccess.inputs.get(id):null;
  if(midiInPort)midiInPort.onmidimessage=onMIDIMessage;
  midiHeldNotes.clear();
}

function sendMIDIChord(rootNote,quality){
  if(!midiOutPort||!document.getElementById('midiSendToggle').checked)return;
  const ch=parseInt(document.getElementById('midiCh').value)||1;
  const statusOn=0x90+(ch-1),statusOff=0x80+(ch-1);
  const intervals=QUALITY[quality]?.intervals||[0,4,7];
  const base=60+rootNote;
  midiActiveNotes.forEach(n=>{midiOutPort.send([statusOff,n,0]);});
  Object.values(midiNoteOffTimers).forEach(clearTimeout);midiNoteOffTimers={};midiActiveNotes.clear();
  const notes=intervals.map(i=>base+i);
  notes.forEach(n=>{midiOutPort.send([statusOn,n,100]);midiActiveNotes.add(n);});
  const timer=setTimeout(()=>{notes.forEach(n=>{if(midiActiveNotes.has(n)){midiOutPort.send([statusOff,n,0]);midiActiveNotes.delete(n);}});},500);
  notes.forEach(n=>midiNoteOffTimers[n]=timer);
}

function onMIDIMessage(ev){
  const[status,note,vel]=ev.data;const cmd=status&0xf0;
  if(cmd===0x90&&vel>0)midiHeldNotes.add(note);
  else if(cmd===0x80||(cmd===0x90&&vel===0))midiHeldNotes.delete(note);
  else return;
  detectChordFromMIDI();
}

const CHORD_TEMPLATES=[
  {name:'major',intervals:[0,4,7]},{name:'minor',intervals:[0,3,7]},
  {name:'dim',intervals:[0,3,6]},{name:'aug',intervals:[0,4,8]},
  {name:'dom7',intervals:[0,4,7,10]},{name:'maj7',intervals:[0,4,7,11]},
  {name:'min7',intervals:[0,3,7,10]},{name:'halfdim',intervals:[0,3,6,10]},
  {name:'dim7',intervals:[0,3,6,9]},{name:'sus2',intervals:[0,2,7]},{name:'sus4',intervals:[0,5,7]},
];

function detectChordFromMIDI(){
  const el=document.getElementById('midiDetected');
  if(midiHeldNotes.size<3){el.textContent='';return;}
  const pcs=[...new Set([...midiHeldNotes].map(n=>n%12))].sort((a,b)=>a-b);
  let best=null;
  for(const tmpl of CHORD_TEMPLATES){
    for(const root of pcs){
      const expected=tmpl.intervals.map(i=>(root+i)%12).sort((a,b)=>a-b);
      if(expected.length===pcs.length&&expected.every((v,i)=>v===pcs[i])){
        best={root,quality:tmpl.name,name:noteName(root,true)+qualitySuffix(tmpl.name)};break;
      }
    }
    if(best)break;
  }
  if(!best){el.textContent='ğŸ¹ '+[...midiHeldNotes].map(n=>noteName(n%12,true)).join(' ');return;}
  el.textContent='ğŸ¹ '+best.name;
  if(document.getElementById('midiNavToggle').checked){setTimeout(()=>setRoot(best.root,best.name),300);}
}

initMIDI();
// Wait for layout to complete before first render
requestAnimationFrame(()=>requestAnimationFrame(()=>{
  init();
  window.addEventListener('resize',()=>render());
}));

// Wire up +/- buttons with addEventListener (onclick can fail on iOS)
document.getElementById('addBtn').addEventListener('touchend',(e)=>{e.preventDefault();e.stopPropagation();addPetal();});
document.getElementById('addBtn').addEventListener('click',(e)=>{e.stopPropagation();addPetal();});
document.getElementById('removeBtn').addEventListener('touchend',(e)=>{e.preventDefault();e.stopPropagation();removePetal();});
document.getElementById('removeBtn').addEventListener('click',(e)=>{e.stopPropagation();removePetal();});
window.addEventListener('resize',()=>render());
</script>
</body>
</html>
